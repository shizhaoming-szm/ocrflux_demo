以下是基于代码的函数调用关系图及解释，按OCRFlux三阶段处理流程梳理：

```
┌─────────────────────────────────────────────────────────────────┐
│  入口函数：process_pdf (协调三阶段处理)                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│  Stage 1: 页面转Markdown                                        │
│  ┌───────────────┐     ┌───────────────┐     ┌───────────────┐  │
│  │ process_task  │◄────┤build_page_to_ │◄────┤ get_page_image│  │
│  │ (page_to_md)  │     │markdown_query │     │ (图像处理)    │  │
│  └───────┬───────┘     └───────────────┘     └───────────────┘  │
└───────────┼─────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────┐
│  后处理：postprocess_markdown_text (清洗Markdown文本)           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│  Stage 2: 元素合并检测                                          │
│  ┌───────────────┐     ┌───────────────────────────────┐        │
│  │ process_task  │◄────┤ build_element_merge_detect_   │        │
│  │ (merge_detect)│     │ query (构建检测提示)          │        │
│  └───────┬───────┘     └───────────────────────────────┘        │
└───────────┼─────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────┐
│  Stage 3: HTML表格合并                                          │
│  ┌───────────────┐     ┌───────────────────────────────┐        │
│  │ process_task  │◄────┤ build_html_table_merge_query  │        │
│  │ (table_merge) │     │ (构建合并提示)                │        │
│  └───────┬───────┘     └───────────────────────────────┘        │
└───────────┼─────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────┐
│  结果整合：build_document_text (生成最终文档)                    │
└─────────────────────────────────────────────────────────────────┘
```

### 关键调用关系解释：

1. **核心协调层**
   - `process_pdf` 是总入口，负责依次调用三阶段处理函数
   - 通过 `asyncio.TaskGroup` 实现多页面/多任务的并行处理

2. **通用通信层**
   - 所有阶段的模型调用都通过 `process_task` 统一处理
   - `process_task` 内部使用 `apost` 函数与vLLM服务器通信，实现HTTP请求发送与响应解析

3. **Stage 1 依赖链**
   - 页面转Markdown需先通过 `get_page_image` 提取PDF页面图像
   - 再由 `build_page_to_markdown_query` 构建包含图像的模型请求
   - 结果经 `postprocess_markdown_text` 清洗后，分割为段落列表

4. **Stage 2 依赖链**
   - 基于Stage 1的输出，`build_element_merge_detect_query` 构建相邻页面元素的检测请求
   - 识别出需要合并的元素对（如跨页表格、段落）

5. **Stage 3 依赖链**
   - 针对Stage 2识别的表格对，`build_html_table_merge_query` 构建表格合并请求
   - 合并结果通过 `build_document_text` 整合到最终文档

6. **工具函数支撑**
   - `table_matrix2html` 负责表格格式转换
   - `metrics` 和 `tracker` 贯穿全程，记录性能指标和任务状态

这种分层调用结构确保了三阶段处理的独立性和可扩展性，同时通过统一的任务处理框架保证了错误重试、并发控制等功能的一致性。










以下是OCRFlux核心函数的入参和出参关系图，重点展示了三个阶段的输入输出流转关系：

```
┌─────────────────────────────────────────────────────────┐
│  入口函数：process_pdf                                 │
│  ┌─────────────── 入参 ────────────────┐               │
│  │ args (配置参数)                     │               │
│  │ worker_id (工作进程ID)              │               │
│  │ pdf_path (PDF/图像路径)             │               │
│  └─────────────────────────────────────┘               │
│                           │                            │
│  ┌─────────────── 出参 ────────────────┐               │
│  │ {                                  │               │
│  │   orig_path: 原始文件路径          │               │
│  │   num_pages: 总页数                │               │
│  │   document_text: 最终文档文本      │               │
│  │   page_texts: 分页文本字典         │               │
│  │   fallback_pages: 失败页面列表     │               │
│  │ }                                  │               │
│  └─────────────────────────────────────┘               │
└───────────────────────────┬─────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────┐
│  Stage 1: Page to Markdown                               │
│  ┌─────────────── 入参 ────────────────┐                │
│  │ args (配置参数)                     │                │
│  │ pdf_path (文件路径)                 │                │
│  │ page_number (页码)                  │                │
│  │ target_longest_image_dim (图像尺寸) │                │
│  │ image_rotation (旋转角度)           │                │
│  └─────────────────────────────────────┘                │
│                           │                             │
│  ┌─────────────── 出参 ────────────────┐                │
│  │ 清洗后的Markdown文本段落列表        │                │
│  │ (过滤图像标记，转换表格格式)        │                │
│  └─────────────────────────────────────┘                │
└───────────────────────────┬─────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────┐
│  后处理：postprocess_markdown_text                       │
│  ┌─────────────── 入参 ────────────────┐                │
│  │ response_text (原始响应文本)        │                │
│  │ pdf_path (文件路径)                 │                │
│  │ page_number (页码)                  │                │
│  └─────────────────────────────────────┘                │
│                           │                             │
│  ┌─────────────── 出参 ────────────────┐                │
│  │ 清理后的Markdown文本                │                │
│  │ (移除图像标记，保留表格和文本)      │                │
│  └─────────────────────────────────────┘                │
└───────────────────────────┬─────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────┐
│  Stage 2: Element Merge Detect                           │
│  ┌─────────────── 入参 ────────────────┐                │
│  │ args (配置参数)                     │                │
│  │ text_list_1 (页面1文本元素列表)     │                │
│  │ text_list_2 (页面2文本元素列表)     │                │
│  └─────────────────────────────────────┘                │
│                           │                             │
│  ┌─────────────── 出参 ────────────────┐                │
│  │ 需要合并的元素索引对列表            │                │
│  │ (格式: [(elem_idx_1, elem_idx_2), ...]) │            │
│  └─────────────────────────────────────┘                │
└───────────────────────────┬─────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────┐
│  Stage 3: HTML Table Merge                               │
│  ┌─────────────── 入参 ────────────────┐                │
│  │ args (配置参数)                     │                │
│  │ text_1 (第一个HTML表格)             │                │
│  │ text_2 (第二个HTML表格)             │                │
│  └─────────────────────────────────────┘                │
│                           │                             │
│  ┌─────────────── 出参 ────────────────┐                │
│  │ 合并后的HTML表格字符串              │                │
│  │ (格式: "<table>...</table>")        │                │
│  └─────────────────────────────────────┘                │
└───────────────────────────┬─────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────┐
│  结果整合：build_document_text                           │
│  ┌─────────────── 入参 ────────────────┐                │
│  │ page_to_markdown_result (阶段1结果) │                │
│  │ element_merge_detect_result (阶段2) │                │
│  │ html_table_merge_result (阶段3)     │                │
│  └─────────────────────────────────────┘                │
│                           │                             │
│  ┌─────────────── 出参 ────────────────┐                │
│  │ 最终整合的文档Markdown文本          │                │
│  └─────────────────────────────────────┘                │
└─────────────────────────────────────────────────────────┘
```

### 关键参数流转说明：

1. **跨阶段数据传递**
   - 阶段1的输出（`page_to_markdown_result`）作为阶段2的输入（`text_list_1`/`text_list_2`）
   - 阶段2识别的表格元素对作为阶段3的输入（`text_1`/`text_2`）
   - 三个阶段的结果最终汇总到`build_document_text`生成最终文档

2. **核心数据结构**
   - `page_to_markdown_result`：字典结构，键为页码，值为文本段落列表
   - `element_merge_detect_result`：字典结构，键为页面对，值为元素索引对列表
   - `html_table_merge_result`：字典结构，键为表格位置标识，值为合并后的表格

3. **参数约束**
   - 图像旋转角度仅支持0/90/180/270度（通过`assert`验证）
   - 表格合并输入必须是完整的HTML表格（通过首尾标签验证）
   - 页面编号从1开始，符合PDF页码习惯

4. **错误处理**
   - 所有阶段通过`process_task`的重试机制处理临时错误
   - 失败页面通过`fallback_pages`记录，超过阈值则丢弃文档

这种参数设计确保了各阶段的解耦和数据的有序流转，同时通过统一的字典结构简化了结果整合逻辑。